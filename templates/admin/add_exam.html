{% extends 'admin/layout.html' %}
{% block title %}Add Exam | Admin Panel{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-lg border-0">
    <!-- Gradient Header -->
    <div class="card-header text-white" 
         style="background: linear-gradient(90deg, #4e73df, #1cc88a);">
      <h3 class="mb-0"><i class="fas fa-clipboard-list"></i> Create New Exam</h3>
    </div>

    <div class="card-body">
      <form method="POST" action="{{ url_for('admin.add_exam') }}">
        {{ form.hidden_tag() }}

        <!-- Title -->
        <div class="mb-3">
          <label class="form-label fw-bold"><i class="fas fa-heading text-primary"></i> {{ form.title.label }}</label>
          {{ form.title(class="form-control", placeholder="Enter exam title") }}
          {% for err in form.title.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
        </div>

        <!-- Class -->
        <div class="mb-3">
          <label class="form-label fw-bold"><i class="fas fa-users text-warning"></i> {{ form.assigned_class.label }}</label>
          {{ form.assigned_class(class="form-select", id="assigned_class") }}
          {% for err in form.assigned_class.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
        </div>

        <!-- Course (visible select + hidden id field) -->
        <div class="mb-3">
          <label class="form-label fw-bold"><i class="fas fa-book text-info"></i> Course</label>

          <!-- visible select populated via JS -->
          <select id="course_name" class="form-select" aria-label="Course select">
            <option value="">Select a class first</option>
          </select>

          <!-- manually render a hidden input for course_id (DO NOT call form.course_id widget) -->
          <input type="hidden" name="{{ form.course_id.name }}" id="course_id" value="{{ form.course_id.data if form.course_id.data is not none else '' }}">

          {% for err in form.course_id.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
        </div>

        <!-- DateTime -->
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold"><i class="fas fa-clock text-success"></i> {{ form.start_datetime.label }}</label>
            {{ form.start_datetime(class="form-control", type="datetime-local") }}
            {% for err in form.start_datetime.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold"><i class="fas fa-hourglass-end text-danger"></i> {{ form.end_datetime.label }}</label>
            {{ form.end_datetime(class="form-control", type="datetime-local") }}
            {% for err in form.end_datetime.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
          </div>
        </div>

        <!-- Duration -->
        <div class="mb-3">
          <label class="form-label fw-bold"><i class="fas fa-stopwatch text-primary"></i> {{ form.duration_minutes.label }}</label>
          {{ form.duration_minutes(class="form-control", id="duration_minutes", placeholder="e.g. 90") }}
          <div id="durationPreview" class="form-text mt-1"></div>
          {% for err in form.duration_minutes.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
        </div>

        <!-- Assignment Mode -->
        <div class="mb-3">
          <label class="form-label fw-bold"><i class="fas fa-random text-dark"></i> {{ form.assignment_mode.label }}</label>
          {{ form.assignment_mode(class="form-select", id="assignment_mode") }}
          <div class="form-text">
            <span class="badge bg-secondary">Random</span> Each student gets a random set.<br>
            <span class="badge bg-info">Hash</span> Deterministic set assignment based on student.<br>
            <span class="badge bg-warning text-dark">Choice</span> Students choose their set manually.
          </div>
          {% for err in form.assignment_mode.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
        </div>

        <!-- Assignment Seed -->
        <div class="mb-3 collapse" id="assignment-seed-group">
          <label class="form-label fw-bold"><i class="fas fa-key text-success"></i> {{ form.assignment_seed.label }}</label>
          {{ form.assignment_seed(class="form-control", placeholder="Optional seed value") }}
          <div class="form-text">Used only in <strong>Hash</strong> mode to make assignments reproducible.</div>
          {% for err in form.assignment_seed.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
        </div>

        <!-- Buttons -->
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-plus-circle"></i> Create Exam
          </button>
          <a href="{{ url_for('admin.manage_exams') }}" class="btn btn-outline-secondary">
            <i class="fas fa-times"></i> Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const classSelect = document.getElementById("assigned_class");
  const courseSelect = document.getElementById("course_name");
  const courseIdInput = document.getElementById("course_id");

  // Helper to safely set hidden input value
  function setHiddenCourseId(id) {
    if (!courseIdInput) return;
    courseIdInput.value = id === null || id === undefined ? '' : String(id);
  }

  function populateCourses(selectedClass, preselectId=null) {
    if (!courseSelect) return;
    courseSelect.disabled = true;
    courseSelect.innerHTML = '<option>Loading...</option>';
    setHiddenCourseId('');

    fetch(`/admin/get_courses/${encodeURIComponent(selectedClass)}`)
      .then(res => {
        if (!res.ok) throw new Error('Network error');
        return res.json();
      })
      .then(data => {
        courseSelect.innerHTML = '';
        courseSelect.disabled = false;

        if (!Array.isArray(data) || data.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No courses available';
          courseSelect.appendChild(opt);
          setHiddenCourseId('');
          return;
        }

        data.forEach(c => {
          const opt = document.createElement('option');
          opt.textContent = c.name;
          opt.value = c.name;      // visible text (keeps parity with Quiz UI)
          opt.dataset.id = String(c.id); // store the actual DB id
          courseSelect.appendChild(opt);
        });

        // Preselect by id if provided
        if (preselectId) {
          const match = Array.from(courseSelect.options).find(o => o.dataset.id === String(preselectId));
          if (match) {
            courseSelect.value = match.value;
            setHiddenCourseId(match.dataset.id);
            return;
          }
        }

        // Otherwise auto-select first valid option and set its id
        const first = Array.from(courseSelect.options).find(o => o.value !== '');
        if (first) {
          courseSelect.value = first.value;
          setHiddenCourseId(first.dataset.id || '');
        } else {
          setHiddenCourseId('');
        }
      })
      .catch(err => {
        console.error('Error loading courses:', err);
        courseSelect.innerHTML = '<option>Error loading courses</option>';
        courseSelect.disabled = false;
        setHiddenCourseId('');
      });
  }

  // Wire class -> courses
  if (classSelect) {
    classSelect.addEventListener('change', function () {
      const cls = this.value || '';
      if (cls) populateCourses(cls);
      else {
        courseSelect.innerHTML = '<option>Select a class first</option>';
        setHiddenCourseId('');
      }
    });

    // If page loaded with a preselected class (edit mode), populate now
    const preClass = classSelect.value || '';
    const preCourseId = courseIdInput && courseIdInput.value ? courseIdInput.value : null;
    if (preClass) populateCourses(preClass, preCourseId);
  }

  // Keep hidden input in sync when user changes visible course
  if (courseSelect && courseIdInput) {
    courseSelect.addEventListener('change', function () {
      const sel = courseSelect.options[courseSelect.selectedIndex];
      setHiddenCourseId(sel?.dataset?.id || '');
    });
  }

  // Assignment Mode toggle
  const modeSelect = document.getElementById("assignment_mode");
  const seedGroup = document.getElementById("assignment-seed-group");
  function toggleSeed() {
    if (!modeSelect) return;
    if (modeSelect.value === 'hash') {
      new bootstrap.Collapse(seedGroup, { show: true });
    } else {
      new bootstrap.Collapse(seedGroup, { hide: true });
    }
  }
  if (modeSelect) {
    modeSelect.addEventListener('change', toggleSeed);
    toggleSeed();
  }

  // Duration preview
  const durationInput = document.getElementById("duration_minutes");
  const durationPreview = document.getElementById("durationPreview");
  function updateDurationPreview() {
    if (!durationInput || !durationPreview) return;
    const mins = parseInt(durationInput.value, 10) || 0;
    if (mins <= 0) {
      durationPreview.innerHTML = "<span class='badge bg-danger'>Invalid duration</span>";
      return;
    }
    const hours = Math.floor(mins / 60);
    const rem = mins % 60;
    let text = "";
    if (hours) text += `${hours}h `;
    if (rem) text += `${rem}m`;
    durationPreview.innerHTML = `<span class="badge bg-success">‚è± ${text.trim()}</span>`;
  }
  if (durationInput) {
    durationInput.addEventListener('input', updateDurationPreview);
    updateDurationPreview();
  }
});
</script>
{% endblock %}
