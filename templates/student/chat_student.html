{% extends 'student/base_student.html' %}
{% block title %}Student Chat{% endblock %}

{% block content %}
<style>
  body {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
  }

  .chat-container {
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  .contact-list {
    max-height: 500px;
    overflow-y: auto;
    border-right: 1px solid #dee2e6;
  }

  .contact-item {
    cursor: pointer;
    border: none;
    transition: background 0.3s;
  }

  .contact-item:hover, .contact-item.active {
    background: #e3f2fd;
    border-left: 4px solid #1976d2;
  }

  #chatMessages {
    height: 420px;
    overflow-y: auto;
    background: #fafafa;
    padding: 15px;
    border-radius: 10px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .chat-bubble {
    display: inline-block;
    padding: 10px 15px;
    border-radius: 15px;
    margin: 5px 0;
    max-width: 75%;
    word-wrap: break-word;
    animation: fadeIn 0.15s ease;
  }

  .sent {
    background: #1976d2;
    color: #fff;
    align-self: flex-end;
  }

  .received {
    background: #f1f1f1;
    color: #000;
    align-self: flex-start;
  }

  .broadcast-tag {
    font-size: 0.7rem;
    margin-left: 8px;
    background: #ffeb3b;
    color: #333;
    padding: 2px 6px;
    border-radius: 8px;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .input-group input {
    border-radius: 20px;
    padding-left: 15px;
  }

  .input-group button {
    border-radius: 20px;
  }

  .card-header {
    background: #1976d2;
    color: white;
    font-weight: bold;
  }

  .badge-new {
    display:inline-block;
    padding: .25rem .5rem;
    font-size:.75rem;
    background:#ffc107;
    color:#111;
    border-radius:8px;
  }
</style>

<div class="container py-4">
  <div class="row chat-container">
    <!-- Sidebar -->
    <div class="col-md-3 p-3 contact-list">
      <h5 class="fw-bold mb-3 text-primary">Contacts</h5>
      <ul class="list-group" id="contactList">
        {% if admin %}
          <li class="list-group-item contact-item" data-id="admin" data-role="admin">
            <i class="fas fa-user-shield text-primary"></i> Admin
          </li>
        {% endif %}
        {% for teacher in teachers %}
          <li class="list-group-item contact-item" data-id="{{ teacher.user_id }}" data-role="teacher">
            <i class="fas fa-chalkboard-teacher text-success"></i> {{ teacher.first_name }} {{ teacher.last_name }}
          </li>
        {% endfor %}
      </ul>

      <div class="mt-4">
        <button id="showBroadcasts" class="btn btn-warning btn-sm w-100">
          <i class="fas fa-bullhorn"></i> View Broadcasts
        </button>
      </div>
    </div>

    <!-- Chat Area -->
    <div class="col-md-9 d-flex flex-column">
      <div class="card flex-grow-1">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span id="chatWith">Select a contact or view broadcasts</span>
          <span id="broadcastBadge" class="badge bg-warning text-dark d-none">New Broadcast</span>
        </div>
        <div class="card-body d-flex flex-column" id="chatMessages"></div>
        <div class="card-footer">
          <div class="input-group">
            <input type="text" id="messageInput" class="form-control" placeholder="Type a message..." disabled>
            <button id="sendBtn" class="btn btn-primary" disabled>
              <i class="fas fa-paper-plane"></i> Send
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
(() => {
  const socket = io();
  const userId = "{{ current_user.user_id }}";
  const userRole = "student";

  let activeReceiver = null;
  let broadcastMode = false;
  let hasUnreadBroadcast = false;

  const contactList = document.getElementById("contactList");
  const chatMessages = document.getElementById("chatMessages");
  const chatWith = document.getElementById("chatWith");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const broadcastBadge = document.getElementById("broadcastBadge");
  const showBroadcastsBtn = document.getElementById("showBroadcasts");

  // Join SocketIO room for real-time delivery
  socket.emit('join', { user_id: userId });

  // Helpers
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

  function appendMessage(msg, className, isBroadcast=false) {
    const div = document.createElement('div');
    div.className = 'chat-bubble ' + className;
    const safeText = escapeHtml(msg.message || '');
    div.innerHTML = `<div><small>${safeText}</small>${isBroadcast ? ' <span class="broadcast-tag">Broadcast</span>' : ''}</div>`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Render an array of messages (simple)
  function renderMessages(messages) {
    chatMessages.innerHTML = '';
    if (!messages || messages.length === 0) {
      chatMessages.innerHTML = '<p class="text-center text-muted mt-3">No messages</p>';
      return;
    }
    messages.forEach(m => {
      const mine = String(m.sender_id) === String(userId);
      appendMessage(m, mine ? 'sent' : 'received', !!m.is_broadcast);
    });
  }

  // Load direct messages for contact
  async function loadDirectMessages(id, name) {
    broadcastMode = false;
    activeReceiver = id;
    chatWith.textContent = name;
    broadcastBadge.classList.add('d-none');
    messageInput.disabled = false;
    sendBtn.disabled = false;
    chatMessages.innerHTML = '<p class="text-center text-muted mt-3">Loading…</p>';
    try {
      const res = await fetch(`/chat/messages/${encodeURIComponent(id)}`);
      if (!res.ok) throw new Error('Failed');
      const data = await res.json();
      renderMessages(data);
    } catch (err) {
      chatMessages.innerHTML = '<p class="text-center text-danger mt-3">Failed to load messages</p>';
      console.error(err);
    }
  }

  // Load persisted broadcasts (server returns broadcasts relevant to this student)
  async function loadBroadcasts() {
    broadcastMode = true;
    activeReceiver = null;
    chatWith.textContent = 'Broadcast Messages';
    messageInput.disabled = true;
    sendBtn.disabled = true;
    chatMessages.innerHTML = '<p class="text-center text-muted mt-3">Loading broadcasts…</p>';
    try {
      const res = await fetch('/chat/messages/broadcast');
      if (!res.ok) throw new Error('Failed');
      const data = await res.json();
      renderMessages(data);
      hasUnreadBroadcast = false;
      broadcastBadge.classList.add('d-none');
    } catch (err) {
      chatMessages.innerHTML = '<p class="text-center text-danger mt-3">Failed to load broadcasts</p>';
      console.error(err);
    }
  }

  // Event: click contact
  contactList.addEventListener('click', (e) => {
    const li = e.target.closest('.contact-item');
    if (!li) return;
    document.querySelectorAll('.contact-item').forEach(i => i.classList.remove('active'));
    li.classList.add('active');
    const id = li.dataset.id;
    const name = li.textContent.trim();
    loadDirectMessages(id, name);
  });

  // Event: show broadcasts
  showBroadcastsBtn.addEventListener('click', () => {
    loadBroadcasts();
  });

  // Send message (direct)
  async function sendMessage() {
    const text = (messageInput.value || '').trim();
    if (!text || !activeReceiver || broadcastMode) return;
    const payload = {
      sender_id: userId,
      sender_role: userRole,
      receiver_id: activeReceiver,
      message: text
    };
    // optimistic UI
    appendMessage(payload, 'sent', false);
    messageInput.value = '';
    socket.emit('send_message', payload);
  }

  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

  // Socket: incoming messages
  socket.on('new_message', (msg) => {
    try {
      if (msg.is_broadcast) {
        // Persisted broadcast messages (created server-side per-recipient) will arrive here too.
        // If broadcast view open, show them inline; otherwise set badge.
        if (broadcastMode) {
          appendMessage(msg, 'received', true);
        } else {
          hasUnreadBroadcast = true;
          broadcastBadge.classList.remove('d-none');
          broadcastBadge.textContent = 'New Broadcast';
        }
        return;
      }

      // Direct message: show if current conversation with sender is open
      if (String(msg.receiver_id) === String(userId)) {
        if (activeReceiver && String(msg.sender_id) === String(activeReceiver)) {
          appendMessage(msg, 'received', false);
        } else {
          // not open: optionally show small notification (here we set a badge)
          // e.g. you could highlight the contact in the list. For now: console + toast (optional)
          console.log('New direct message from', msg.sender_id);
        }
      }
    } catch (err) {
      console.error('new_message handler error', err);
    }
  });

  // On connect: ensure server room joined (server also does join on 'join' event)
  socket.on('connect', () => {
    socket.emit('join', { user_id: userId });
  });

  // on page load
window.addEventListener('load', () => {
  loadBroadcasts();
});

// when clicking broadcast channel
async function loadBroadcastChannel(btn) {
  activeBroadcastButton = btn;
  broadcastMode = true;
  receiverId = null;
  chatHeader.textContent = `Broadcast — ${btn.textContent}`;
  await loadBroadcasts();  // fetch all persisted messages
}


})();
</script>
{% endblock %}
